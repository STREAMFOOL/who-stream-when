{{template "base" .}}

{{define "title"}}{{.Streamer.Name}} - Who Live When{{end}}

{{define "content"}}
<a href="/" class="back-link">â† Back to Home</a>

<!-- Live Status Section - Prominent at Top -->
<div class="live-status-card {{if and .LiveStatus .LiveStatus.IsLive}}is-live{{else}}is-offline{{end}}" id="live-status"
    hx-get="/api/livestatus/{{.Streamer.ID}}" hx-trigger="every 60s" hx-swap="innerHTML">
    {{if .LiveStatus}}
    {{if .LiveStatus.IsLive}}
    <h2>ğŸ”´ Live Now on {{.LiveStatus.Platform}}</h2>
    {{if .LiveStatus.Title}}
    <p class="stream-title-prominent">{{.LiveStatus.Title}}</p>
    {{end}}
    {{if gt .LiveStatus.ViewerCount 0}}
    <p class="viewer-count-prominent">ğŸ‘ {{.LiveStatus.ViewerCount}} watching</p>
    {{end}}
    {{if .LiveStatus.StreamURL}}
    <a href="{{.LiveStatus.StreamURL}}" target="_blank" class="btn-watch-now">â–¶ Watch Now</a>
    {{end}}
    {{else}}
    <h2>Currently Offline</h2>
    {{if .LiveStatus.UpdatedAt}}
    <p class="last-seen">Last checked: {{.LiveStatus.UpdatedAt.Format "Jan 2, 3:04 PM"}}</p>
    {{end}}
    <p>This streamer is not currently live. Check the heatmap below to see when they usually stream.</p>
    <button class="btn-refresh" onclick="htmx.trigger('#live-status', 'htmx:trigger')">ğŸ”„ Refresh Status</button>
    {{end}}
    {{else}}
    <h2>âš ï¸ Status Unknown</h2>
    <p class="status-unknown-message">Unable to reach Kick. This could be temporary.</p>
    <button class="btn-refresh" onclick="htmx.trigger('#live-status', 'htmx:trigger')">ğŸ”„ Retry</button>
    {{end}}
</div>

<!-- Streamer Profile Section -->
<div class="streamer-profile-card">
    <div class="streamer-header">
        <div class="streamer-info">
            <h1>{{.Streamer.Name}}</h1>
            <div class="platform-tags">
                {{range .Streamer.Platforms}}
                <span class="platform-tag">{{.}}</span>
                {{end}}
            </div>
            {{if .ChannelInfo}}
            {{if .ChannelInfo.Description}}
            <p class="streamer-bio">{{.ChannelInfo.Description}}</p>
            {{end}}
            {{end}}
        </div>

        <div class="streamer-actions">
            <form action="/programme/add/{{.Streamer.ID}}" method="POST">
                <button type="submit" class="btn btn-primary">Add to Programme</button>
            </form>
        </div>
    </div>
</div>

<!-- Platform Links Section -->
<div class="heatmap-container">
    <h2>Platform Links</h2>
    <div class="platform-links-list">
        {{range $platform, $handle := .Streamer.Handles}}
        <div class="platform-link-item">
            {{if eq $platform "kick"}}
            <span class="platform-icon">ğŸŸ¢</span>
            <strong>Kick:</strong>
            <a href="https://kick.com/{{$handle}}" target="_blank" rel="noopener noreferrer" class="platform-link"
                data-platform="kick" data-handle="{{$handle}}">
                kick.com/{{$handle}}
            </a>
            {{else if eq $platform "twitch"}}
            <span class="platform-icon">ğŸŸ£</span>
            <strong>Twitch:</strong>
            <a href="https://twitch.tv/{{$handle}}" target="_blank" rel="noopener noreferrer" class="platform-link"
                data-platform="twitch" data-handle="{{$handle}}">
                twitch.tv/{{$handle}}
            </a>
            {{else if eq $platform "youtube"}}
            <span class="platform-icon">ğŸ”´</span>
            <strong>YouTube:</strong>
            <a href="https://youtube.com/@{{$handle}}" target="_blank" rel="noopener noreferrer" class="platform-link"
                data-platform="youtube" data-handle="{{$handle}}">
                youtube.com/@{{$handle}}
            </a>
            {{else}}
            <span class="platform-icon">ğŸ”µ</span>
            <strong>{{$platform}}:</strong>
            <span>{{$handle}}</span>
            {{end}}
        </div>
        {{end}}
    </div>
</div>


<!-- Activity Heatmap -->
{{if .Heatmap}}
<div class="heatmap-container">
    <h2>Activity Heatmap</h2>
    <p style="color: #6b7280; margin-bottom: 1rem;">Based on {{.Heatmap.DataPoints}} data points</p>

    <div class="heatmap-section">
        <h3>Hours of Day (UTC)</h3>
        <div class="heatmap-row">
            {{range $hour, $prob := .Heatmap.Hours}}
            {{$intensity := printf "%.0f" (mul $prob 100)}}
            <div class="heatmap-cell" style="background-color: rgba(34, 197, 94, {{printf " %.2f" $prob}});"
                title="{{$hour}}:00 - {{$intensity}}% activity">
                {{$hour}}
            </div>
            {{end}}
        </div>
    </div>

    <div class="heatmap-section">
        <h3>Days of Week</h3>
        <div class="heatmap-row">
            {{$days := list "Sun" "Mon" "Tue" "Wed" "Thu" "Fri" "Sat"}}
            {{range $day, $prob := .Heatmap.DaysOfWeek}}
            {{$intensity := printf "%.0f" (mul $prob 100)}}
            <div class="heatmap-cell heatmap-day" style="background-color: rgba(34, 197, 94, {{printf " %.2f" $prob}});"
                title="{{index $days $day}} - {{$intensity}}% activity">
                {{index $days $day}}
            </div>
            {{end}}
        </div>
    </div>

    <div class="heatmap-legend">
        <span>Less active</span>
        <div class="legend-gradient"></div>
        <span>More active</span>
    </div>
</div>
{{else}}
<div class="heatmap-container">
    <h2>Activity Heatmap</h2>
    <div class="insufficient-data">
        <strong>Insufficient Data</strong>
        <p>This streamer doesn't have enough historical data to generate an activity heatmap yet. Check back later!</p>
    </div>
</div>
{{end}}
{{end}}